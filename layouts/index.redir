{{- /* -}}
# Redirect map for Netlify, CloudFlare etc.
# Discussion: https://discourse.gohugo.io/t/aliases-are-broken/12318/6
# Source: https://github.com/gohugoio/gohugoioTheme/blob/master/layouts/index.redir
# https://github.com/gohugoio/hugoDocs/blob/master/config/_default/config.toml
# We do redirects via an include file for  Netlify, CloudFlare etc., generated by Hugo (see "outputs" below).
# Add be below TOML lines to config.toml to make sure the redirects map file is generated
# disableAliases = true
# [outputs]
# home = [ "HTML", "RSS", "REDIR" ]
# section = [ "HTML", "RSS"]
#
# [mediaTypes]
#   [mediaTypes."text/redirects"]
#     delimiter = ""
#
# [outputFormats]
# [outputFormats.REDIR]
# mediatype = "text/redirects"
# baseName = "_redirects"
# isPlainText = true
# notAlternative = true
{{- */ -}}

{{- $redirectHttpStatus := 301 -}}
{{- $redirects := slice -}}
{{- $pathMax := 0 }}
{{- $targetMax := 0 }}
{{- $statusMax := (len (print "%v" $redirectHttpStatus)) -}}
{{- $debug := false -}}

# Redirects for Netlify, CloudFlare etc.
# Generated by layout "layouts/index.redir"
{{- range .Sites -}}
  {{- $langPrefix := .LanguagePrefix }}
# Language prefix: {{ $langPrefix }}
  {{- range $p := .Pages -}}
    {{- range $alias := .Aliases -}}
      {{- $pathsToMatch := slice }}
      {{- $aliasPath := $alias }}
      {{- if not (hasPrefix $aliasPath "/") -}}
        {{- /* Directory-relative alias: Combine with the page's directory */ -}}
        {{- $pageDir := path.Dir (path.Dir $p.RelPermalink) -}}
        {{- $aliasPath = path.Join $pageDir $aliasPath -}}
        {{- if $debug }}{{- warnf "index.redir: added directory:\nalias:         %v\npageDir:       %v\naliasPath:     %v" $alias $pageDir $aliasPath -}}{{- end -}}
      {{- end -}}
      {{- if not (findRE `(?:[^/.]+/|[.][^/.]+)$` $aliasPath) }}
        {{- $pathWithSlash := printf "%s/" $aliasPath }}
        {{- if $debug }}{{- warnf "index.redir: added path with trailing slash:\nalias:         %v\naliasPath:     %v\npathWithSlash: %v" $alias $aliasPath $pathWithSlash -}}{{- end -}}
        {{- $pathsToMatch = append $pathWithSlash $pathsToMatch }}
      {{- end -}}
      {{- if and $langPrefix (not (hasPrefix $aliasPath $langPrefix) ) }}
        {{- $aliasPath = printf "%s%s" $langPrefix $aliasPath }}
        {{- if $debug }}{{- warnf "index.aliases: added language prefix '%v':\nalias:         %v\naliasPath:     %v" $langPrefix $alias $aliasPath -}}{{- end -}}
      {{- end }}
      {{- $pathsToMatch = append $aliasPath $pathsToMatch }}
      {{- range $path := $pathsToMatch }}
        {{- $pathMax = math.Max (len $path) $pathMax }}
        {{- $target := $p.RelPermalink }}
        {{- $targetMax = math.Max (len $target) $targetMax }}
        {{- $redirects = append (dict "path" $path "target" $target "status" $redirectHttpStatus) $redirects }}
      {{- end -}}
    {{- end -}}
  {{- end }}

  {{- /* Read and parse JSON file with all URLs that
        have been accessed recently and frequently */ -}}
  {{- range .Data.redirects -}}
    {{- $path := .path -}}
    {{- $target := .target -}}
    {{- $status := int (.status | default $redirectHttpStatus) -}}
    {{- $exists := false -}}
    {{- range  $redirects -}}
      {{- if eq .path $path -}}
        {{- $exists = true -}}
      {{- end -}}
    {{- end -}}
    {{- if not $exists -}}
      {{- $pathMax = math.Max (len $path) $pathMax }}
      {{- $targetMax = math.Max (len $target) $targetMax }}
      {{- $redirects = append (dict "path" $path "target" $target "status" $status) $redirects -}}
    {{- end -}}
  {{- end }}
{{- end }}

{{ range (sort $redirects "path" "asc") | uniq -}}
  {{- printf "%-*s %-*s %d\n" (int $pathMax) .path (int $targetMax) .target .status -}}
{{- end -}}
# End of redirects
